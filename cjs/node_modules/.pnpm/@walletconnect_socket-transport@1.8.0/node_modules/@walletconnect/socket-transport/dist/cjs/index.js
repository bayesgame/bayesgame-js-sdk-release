"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e=require("../../../../../../../../_virtual/_commonjsHelpers.js"),s=require("../../../../../../../../_virtual/index6.js"),o=require("../../../../../../../../_virtual/__tslib.js"),i=require("../../../../../../@walletconnect_utils@1.8.0/node_modules/@walletconnect/utils/dist/cjs/index.js"),r=require("./network.js"),n=require("../../../../../../ws@7.5.3/node_modules/ws/index.js");exports.__require=function(){if(t)return s.__exports;t=1,Object.defineProperty(s.__exports,"__esModule",{value:!0});const c=o.default,_=i.__require(),u=c.__importDefault(r.__require()),h=void 0!==e.commonjsGlobal.WebSocket?e.commonjsGlobal.WebSocket:n.__require();return s.__exports.default=class{constructor(t){if(this.opts=t,this._queue=[],this._events=[],this._subscriptions=[],this._protocol=t.protocol,this._version=t.version,this._url="",this._netMonitor=null,this._socket=null,this._nextSocket=null,this._subscriptions=t.subscriptions||[],this._netMonitor=t.netMonitor||new u.default,!t.url||"string"!=typeof t.url)throw new Error("Missing or invalid WebSocket url");this._url=t.url,this._netMonitor.on("online",(()=>this._socketCreate()))}set readyState(t){}get readyState(){return this._socket?this._socket.readyState:-1}set connecting(t){}get connecting(){return 0===this.readyState}set connected(t){}get connected(){return 1===this.readyState}set closing(t){}get closing(){return 2===this.readyState}set closed(t){}get closed(){return 3===this.readyState}open(){this._socketCreate()}close(){this._socketClose()}send(t,e,s){if(!e||"string"!=typeof e)throw new Error("Missing or invalid topic field");this._socketSend({topic:e,type:"pub",payload:t,silent:!!s})}subscribe(t){this._socketSend({topic:t,type:"sub",payload:"",silent:!0})}on(t,e){this._events.push({event:t,callback:e})}_socketCreate(){if(this._nextSocket)return;const t=function(t,e,s){var o,i;const r=t.startsWith("https")?t.replace("https","wss"):t.startsWith("http")?t.replace("http","ws"):t,n=r.split("?"),c=(0,_.isBrowser)()?{protocol:e,version:s,env:"browser",host:(null===(o=(0,_.getLocation)())||void 0===o?void 0:o.host)||""}:{protocol:e,version:s,env:(null===(i=(0,_.detectEnv)())||void 0===i?void 0:i.name)||""},u=(0,_.appendToQueryString)((0,_.getQueryString)(n[1]||""),c);return n[0]+"?"+u}(this._url,this._protocol,this._version);if(this._nextSocket=new h(t),!this._nextSocket)throw new Error("Failed to create socket");this._nextSocket.onmessage=t=>this._socketReceive(t),this._nextSocket.onopen=()=>this._socketOpen(),this._nextSocket.onerror=t=>this._socketError(t),this._nextSocket.onclose=()=>{setTimeout((()=>{this._nextSocket=null,this._socketCreate()}),1e3)}}_socketOpen(){this._socketClose(),this._socket=this._nextSocket,this._nextSocket=null,this._queueSubscriptions(),this._pushQueue()}_socketClose(){this._socket&&(this._socket.onclose=()=>{},this._socket.close())}_socketSend(t){const e=JSON.stringify(t);this._socket&&1===this._socket.readyState?this._socket.send(e):(this._setToQueue(t),this._socketCreate())}_socketReceive(t){return c.__awaiter(this,void 0,void 0,(function*(){let e;try{e=JSON.parse(t.data)}catch(t){return}if(this._socketSend({topic:e.topic,type:"ack",payload:"",silent:!0}),this._socket&&1===this._socket.readyState){const t=this._events.filter((t=>"message"===t.event));t&&t.length&&t.forEach((t=>t.callback(e)))}}))}_socketError(t){const e=this._events.filter((t=>"error"===t.event));e&&e.length&&e.forEach((e=>e.callback(t)))}_queueSubscriptions(){this._subscriptions.forEach((t=>this._queue.push({topic:t,type:"sub",payload:"",silent:!0}))),this._subscriptions=this.opts.subscriptions||[]}_setToQueue(t){this._queue.push(t)}_pushQueue(){this._queue.forEach((t=>this._socketSend(t))),this._queue=[]}},s.__exports};
