"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("../../../../../@ethersproject_address@5.7.0/node_modules/@ethersproject/address/lib.esm/index.js"),e=require("../../../../../@ethersproject_bytes@5.7.0/node_modules/@ethersproject/bytes/lib.esm/index.js"),t=require("../../../../../@ethersproject_keccak256@5.7.0/node_modules/@ethersproject/keccak256/lib.esm/index.js"),n=require("../../../../../@ethersproject_properties@5.7.0/node_modules/@ethersproject/properties/lib.esm/index.js"),i=require("../../../../../@ethersproject_logger@5.7.0/node_modules/@ethersproject/logger/lib.esm/index.js"),o=require("./_version.js"),s=require("./id.js"),a=require("../../../../../@ethersproject_bignumber@5.7.0/node_modules/@ethersproject/bignumber/lib.esm/bignumber.js"),c=function(r,e,t,n){return new(t||(t=Promise))((function(i,o){function s(r){try{c(n.next(r))}catch(r){o(r)}}function a(r){try{c(n.throw(r))}catch(r){o(r)}}function c(r){var e;r.done?i(r.value):(e=r.value,e instanceof t?e:new t((function(r){r(e)}))).then(s,a)}c((n=n.apply(r,e||[])).next())}))};const u=new i.Logger(o.version),f=new Uint8Array(32);f.fill(0);const h=a.BigNumber.from(-1),m=a.BigNumber.from(0),y=a.BigNumber.from(1),d=a.BigNumber.from("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");const p=e.hexZeroPad(y.toHexString(),32),g=e.hexZeroPad(m.toHexString(),32),l={name:"string",version:"string",chainId:"uint256",verifyingContract:"address",salt:"bytes32"},v=["name","version","chainId","verifyingContract","salt"];function w(r){return function(e){return"string"!=typeof e&&u.throwArgumentError(`invalid domain value for ${JSON.stringify(r)}`,`domain.${r}`,e),e}}const b={name:w("name"),version:w("version"),chainId:function(r){try{return a.BigNumber.from(r).toString()}catch(r){}return u.throwArgumentError('invalid domain value for "chainId"',"domain.chainId",r)},verifyingContract:function(e){try{return r.getAddress(e).toLowerCase()}catch(r){}return u.throwArgumentError('invalid domain value "verifyingContract"',"domain.verifyingContract",e)},salt:function(r){try{const t=e.arrayify(r);if(32!==t.length)throw new Error("bad length");return e.hexlify(t)}catch(r){}return u.throwArgumentError('invalid domain value "salt"',"domain.salt",r)}};function E(n){{const r=n.match(/^(u?)int(\d*)$/);if(r){const t=""===r[1],i=parseInt(r[2]||"256");(i%8!=0||i>256||r[2]&&r[2]!==String(i))&&u.throwArgumentError("invalid numeric width","type",n);const o=d.mask(t?i-1:i),s=t?o.add(y).mul(h):m;return function(r){const t=a.BigNumber.from(r);return(t.lt(s)||t.gt(o))&&u.throwArgumentError(`value out-of-bounds for ${n}`,"value",r),e.hexZeroPad(t.toTwos(256).toHexString(),32)}}}{const r=n.match(/^bytes(\d+)$/);if(r){const t=parseInt(r[1]);return(0===t||t>32||r[1]!==String(t))&&u.throwArgumentError("invalid bytes width","type",n),function(r){return e.arrayify(r).length!==t&&u.throwArgumentError(`invalid length for ${n}`,"value",r),function(r){const t=e.arrayify(r),n=t.length%32;return n?e.hexConcat([t,f.slice(n)]):e.hexlify(t)}(r)}}}switch(n){case"address":return function(t){return e.hexZeroPad(r.getAddress(t),32)};case"bool":return function(r){return r?p:g};case"bytes":return function(r){return t.keccak256(r)};case"string":return function(r){return s.id(r)}}return null}function x(r,e){return`${r}(${e.map((({name:r,type:e})=>e+" "+r)).join(",")})`}class j{constructor(r){n.defineReadOnly(this,"types",Object.freeze(n.deepCopy(r))),n.defineReadOnly(this,"_encoderCache",{}),n.defineReadOnly(this,"_types",{});const e={},t={},i={};Object.keys(r).forEach((r=>{e[r]={},t[r]=[],i[r]={}}));for(const n in r){const i={};r[n].forEach((o=>{i[o.name]&&u.throwArgumentError(`duplicate variable name ${JSON.stringify(o.name)} in ${JSON.stringify(n)}`,"types",r),i[o.name]=!0;const s=o.type.match(/^([^\x5b]*)(\x5b|$)/)[1];s===n&&u.throwArgumentError(`circular type reference to ${JSON.stringify(s)}`,"types",r);E(s)||(t[s]||u.throwArgumentError(`unknown type ${JSON.stringify(s)}`,"types",r),t[s].push(n),e[n][s]=!0)}))}const o=Object.keys(t).filter((r=>0===t[r].length));0===o.length?u.throwArgumentError("missing primary type","types",r):o.length>1&&u.throwArgumentError(`ambiguous primary types or unused types: ${o.map((r=>JSON.stringify(r))).join(", ")}`,"types",r),n.defineReadOnly(this,"primaryType",o[0]),function n(o,s){s[o]&&u.throwArgumentError(`circular type reference to ${JSON.stringify(o)}`,"types",r),s[o]=!0,Object.keys(e[o]).forEach((r=>{t[r]&&(n(r,s),Object.keys(s).forEach((e=>{i[e][r]=!0})))})),delete s[o]}(this.primaryType,{});for(const e in i){const t=Object.keys(i[e]);t.sort(),this._types[e]=x(e,r[e])+t.map((e=>x(e,r[e]))).join("")}}getEncoder(r){let e=this._encoderCache[r];return e||(e=this._encoderCache[r]=this._getEncoder(r)),e}_getEncoder(r){{const e=E(r);if(e)return e}const n=r.match(/^(.*)(\x5b(\d*)\x5d)$/);if(n){const r=n[1],i=this.getEncoder(r),o=parseInt(n[3]);return n=>{o>=0&&n.length!==o&&u.throwArgumentError("array length mismatch; expected length ${ arrayLength }","value",n);let s=n.map(i);return this._types[r]&&(s=s.map(t.keccak256)),t.keccak256(e.hexConcat(s))}}const i=this.types[r];if(i){const n=s.id(this._types[r]);return r=>{const o=i.map((({name:e,type:n})=>{const i=this.getEncoder(n)(r[e]);return this._types[n]?t.keccak256(i):i}));return o.unshift(n),e.hexConcat(o)}}return u.throwArgumentError(`unknown type: ${r}`,"type",r)}encodeType(r){const e=this._types[r];return e||u.throwArgumentError(`unknown type: ${JSON.stringify(r)}`,"name",r),e}encodeData(r,e){return this.getEncoder(r)(e)}hashStruct(r,e){return t.keccak256(this.encodeData(r,e))}encode(r){return this.encodeData(this.primaryType,r)}hash(r){return this.hashStruct(this.primaryType,r)}_visit(r,e,t){if(E(r))return t(r,e);const n=r.match(/^(.*)(\x5b(\d*)\x5d)$/);if(n){const r=n[1],i=parseInt(n[3]);return i>=0&&e.length!==i&&u.throwArgumentError("array length mismatch; expected length ${ arrayLength }","value",e),e.map((e=>this._visit(r,e,t)))}const i=this.types[r];return i?i.reduce(((r,{name:n,type:i})=>(r[n]=this._visit(i,e[n],t),r)),{}):u.throwArgumentError(`unknown type: ${r}`,"type",r)}visit(r,e){return this._visit(this.primaryType,r,e)}static from(r){return new j(r)}static getPrimaryType(r){return j.from(r).primaryType}static hashStruct(r,e,t){return j.from(e).hashStruct(r,t)}static hashDomain(r){const e=[];for(const t in r){const n=l[t];n||u.throwArgumentError(`invalid typed-data domain key: ${JSON.stringify(t)}`,"domain",r),e.push({name:t,type:n})}return e.sort(((r,e)=>v.indexOf(r.name)-v.indexOf(e.name))),j.hashStruct("EIP712Domain",{EIP712Domain:e},r)}static encode(r,t,n){return e.hexConcat(["0x1901",j.hashDomain(r),j.from(t).hash(n)])}static hash(r,e,n){return t.keccak256(j.encode(r,e,n))}static resolveNames(r,t,i,o){return c(this,void 0,void 0,(function*(){r=n.shallowCopy(r);const s={};r.verifyingContract&&!e.isHexString(r.verifyingContract,20)&&(s[r.verifyingContract]="0x");const a=j.from(t);a.visit(i,((r,t)=>("address"!==r||e.isHexString(t,20)||(s[t]="0x"),t)));for(const r in s)s[r]=yield o(r);return r.verifyingContract&&s[r.verifyingContract]&&(r.verifyingContract=s[r.verifyingContract]),i=a.visit(i,((r,e)=>"address"===r&&s[e]?s[e]:e)),{domain:r,value:i}}))}static getPayload(r,t,i){j.hashDomain(r);const o={},s=[];v.forEach((e=>{const t=r[e];null!=t&&(o[e]=b[e](t),s.push({name:e,type:l[e]}))}));const c=j.from(t),f=n.shallowCopy(t);return f.EIP712Domain?u.throwArgumentError("types must not contain EIP712Domain type","types.EIP712Domain",t):f.EIP712Domain=s,c.encode(i),{types:f,domain:o,primaryType:c.primaryType,message:c.visit(i,((r,t)=>{if(r.match(/^bytes(\d*)/))return e.hexlify(e.arrayify(t));if(r.match(/^u?int/))return a.BigNumber.from(t).toString();switch(r){case"address":return t.toLowerCase();case"bool":return!!t;case"string":return"string"!=typeof t&&u.throwArgumentError("invalid string","value",t),t}return u.throwArgumentError("unsupported type","type",r)}))}}}exports.TypedDataEncoder=j;
