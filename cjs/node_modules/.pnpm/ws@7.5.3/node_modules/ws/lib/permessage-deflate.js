"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("zlib"),t=require("./buffer-util.js"),i=require("./limiter.js"),s=require("./constants.js");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r,o,a=n(e);exports.__require=function(){if(o)return r;o=1;const e=a.default,n=t.__require(),_=i.__require(),{kStatusCode:l,NOOP:h}=s.__require(),c=Buffer.from([0,0,255,255]),f=Symbol("permessage-deflate"),d=Symbol("total-length"),w=Symbol("callback"),p=Symbol("buffers"),m=Symbol("error");let u;function x(e){this[p].push(e),this[d]+=e.length}function v(e){this[d]+=e.length,this[f]._maxPayload<1||this[d]<=this[f]._maxPayload?this[p].push(e):(this[m]=new RangeError("Max payload size exceeded"),this[m].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[m][l]=1009,this.removeListener("data",v),this.reset())}function b(e){this[f]._inflate=null,e[l]=1007,this[w](e)}return r=class{constructor(e,t,i){if(this._maxPayload=0|i,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!u){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;u=new _(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[w];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,i=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!i)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(i.server_no_context_takeover=!0),t.clientNoContextTakeover&&(i.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(i.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?i.client_max_window_bits=t.clientMaxWindowBits:!0!==i.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete i.client_max_window_bits,i}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let i=e[t];if(i.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(i=i[0],"client_max_window_bits"===t){if(!0!==i){const e=+i;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${i}`);i=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${i}`)}else if("server_max_window_bits"===t){const e=+i;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${i}`);i=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==i)throw new TypeError(`Invalid value for parameter "${t}": ${i}`)}e[t]=i}))})),e}decompress(e,t,i){u.add((s=>{this._decompress(e,t,((e,t)=>{s(),i(e,t)}))}))}compress(e,t,i){u.add((s=>{this._compress(e,t,((e,t)=>{s(),i(e,t)}))}))}_decompress(t,i,s){const r=this._isServer?"client":"server";if(!this._inflate){const t=`${r}_max_window_bits`,i="number"!=typeof this.params[t]?e.Z_DEFAULT_WINDOWBITS:this.params[t];this._inflate=e.createInflateRaw({...this._options.zlibInflateOptions,windowBits:i}),this._inflate[f]=this,this._inflate[d]=0,this._inflate[p]=[],this._inflate.on("error",b),this._inflate.on("data",v)}this._inflate[w]=s,this._inflate.write(t),i&&this._inflate.write(c),this._inflate.flush((()=>{const e=this._inflate[m];if(e)return this._inflate.close(),this._inflate=null,void s(e);const t=n.concat(this._inflate[p],this._inflate[d]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[d]=0,this._inflate[p]=[],i&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,t)}))}_compress(t,i,s){const r=this._isServer?"server":"client";if(!this._deflate){const t=`${r}_max_window_bits`,i="number"!=typeof this.params[t]?e.Z_DEFAULT_WINDOWBITS:this.params[t];this._deflate=e.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:i}),this._deflate[d]=0,this._deflate[p]=[],this._deflate.on("error",h),this._deflate.on("data",x)}this._deflate[w]=s,this._deflate.write(t),this._deflate.flush(e.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=n.concat(this._deflate[p],this._deflate[d]);i&&(e=e.slice(0,e.length-4)),this._deflate[w]=null,this._deflate[d]=0,this._deflate[p]=[],i&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,e)}))}}};
