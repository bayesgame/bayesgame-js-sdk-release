"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../../../../../../_virtual/png2.js"),i=require("util"),e=require("stream");require("./parser-async.js"),require("./packer-async.js"),require("./png-sync.js");var r=require("../../../../../../_virtual/png-sync.js"),a=require("../../../../../../_virtual/parser-async.js"),s=require("../../../../../../_virtual/packer-async.js");function h(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=h(i),o=h(e),d=n.default,p=o.default,u=a.parserAsync.exports,c=s.packerAsync.exports,l=r.__exports,m=t.__exports.PNG=function(t){p.call(this),t=t||{},this.width=0|t.width,this.height=0|t.height,this.data=this.width>0&&this.height>0?new Buffer(4*this.width*this.height):null,t.fill&&this.data&&this.data.fill(0),this.gamma=0,this.readable=this.writable=!0,this._parser=new u(t),this._parser.on("error",this.emit.bind(this,"error")),this._parser.on("close",this._handleClose.bind(this)),this._parser.on("metadata",this._metadata.bind(this)),this._parser.on("gamma",this._gamma.bind(this)),this._parser.on("parsed",function(t){this.data=t,this.emit("parsed",t)}.bind(this)),this._packer=new c(t),this._packer.on("data",this.emit.bind(this,"data")),this._packer.on("end",this.emit.bind(this,"end")),this._parser.on("close",this._handleClose.bind(this)),this._packer.on("error",this.emit.bind(this,"error"))};d.inherits(m,p),m.sync=l,m.prototype.pack=function(){return this.data&&this.data.length?(process.nextTick(function(){this._packer.pack(this.data,this.width,this.height,this.gamma)}.bind(this)),this):(this.emit("error","No data provided"),this)},m.prototype.parse=function(t,i){var e,r;i&&(e=function(t){this.removeListener("error",r),this.data=t,i(null,this)}.bind(this),r=function(t){this.removeListener("parsed",e),i(t,null)}.bind(this),this.once("parsed",e),this.once("error",r));return this.end(t),this},m.prototype.write=function(t){return this._parser.write(t),!0},m.prototype.end=function(t){this._parser.end(t)},m.prototype._metadata=function(t){this.width=t.width,this.height=t.height,this.emit("metadata",t)},m.prototype._gamma=function(t){this.gamma=t},m.prototype._handleClose=function(){this._parser.writable||this._packer.readable||this.emit("close")},m.bitblt=function(t,i,e,r,a,s,h,n){if(r|=0,a|=0,s|=0,h|=0,n|=0,(e|=0)>t.width||r>t.height||e+a>t.width||r+s>t.height)throw new Error("bitblt reading outside image");if(h>i.width||n>i.height||h+a>i.width||n+s>i.height)throw new Error("bitblt writing outside image");for(var o=0;o<s;o++)t.data.copy(i.data,(n+o)*i.width+h<<2,(r+o)*t.width+e<<2,(r+o)*t.width+e+a<<2)},m.prototype.bitblt=function(t,i,e,r,a,s,h){return m.bitblt(this,t,i,e,r,a,s,h),this},m.adjustGamma=function(t){if(t.gamma){for(var i=0;i<t.height;i++)for(var e=0;e<t.width;e++)for(var r=t.width*i+e<<2,a=0;a<3;a++){var s=t.data[r+a]/255;s=Math.pow(s,1/2.2/t.gamma),t.data[r+a]=Math.round(255*s)}t.gamma=0}},m.prototype.adjustGamma=function(){m.adjustGamma(this)},exports.default=t.__exports;
