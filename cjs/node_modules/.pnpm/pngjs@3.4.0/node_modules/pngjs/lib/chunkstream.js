"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../../../../../_virtual/chunkstream.js"),t=require("util"),s=require("stream");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=r(t),h=r(s),f=i.default,n=h.default,u=e.chunkstream.exports=function(){n.call(this),this._buffers=[],this._buffered=0,this._reads=[],this._paused=!1,this._encoding="utf8",this.writable=!0};f.inherits(u,n),u.prototype.read=function(e,t){this._reads.push({length:Math.abs(e),allowLess:e<0,func:t}),process.nextTick(function(){this._process(),this._paused&&this._reads.length>0&&(this._paused=!1,this.emit("drain"))}.bind(this))},u.prototype.write=function(e,t){return this.writable?(s=Buffer.isBuffer(e)?e:new Buffer(e,t||this._encoding),this._buffers.push(s),this._buffered+=s.length,this._process(),this._reads&&0===this._reads.length&&(this._paused=!0),this.writable&&!this._paused):(this.emit("error",new Error("Stream not writable")),!1);var s},u.prototype.end=function(e,t){e&&this.write(e,t),this.writable=!1,this._buffers&&(0===this._buffers.length?this._end():(this._buffers.push(null),this._process()))},u.prototype.destroySoon=u.prototype.end,u.prototype._end=function(){this._reads.length>0&&this.emit("error",new Error("Unexpected end of input")),this.destroy()},u.prototype.destroy=function(){this._buffers&&(this.writable=!1,this._reads=null,this._buffers=null,this.emit("close"))},u.prototype._processReadAllowingLess=function(e){this._reads.shift();var t=this._buffers[0];t.length>e.length?(this._buffered-=e.length,this._buffers[0]=t.slice(e.length),e.func.call(this,t.slice(0,e.length))):(this._buffered-=t.length,this._buffers.shift(),e.func.call(this,t))},u.prototype._processRead=function(e){this._reads.shift();for(var t=0,s=0,r=new Buffer(e.length);t<e.length;){var i=this._buffers[s++],h=Math.min(i.length,e.length-t);i.copy(r,t,0,h),t+=h,h!==i.length&&(this._buffers[--s]=i.slice(h))}s>0&&this._buffers.splice(0,s),this._buffered-=e.length,e.func.call(this,r)},u.prototype._process=function(){try{for(;this._buffered>0&&this._reads&&this._reads.length>0;){var e=this._reads[0];if(e.allowLess)this._processReadAllowingLess(e);else{if(!(this._buffered>=e.length))break;this._processRead(e)}}this._buffers&&!this.writable&&this._end()}catch(e){this.emit("error",e)}},exports.default=e.chunkstream.exports;
