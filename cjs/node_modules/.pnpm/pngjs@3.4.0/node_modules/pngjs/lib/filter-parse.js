"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../../../../../_virtual/filter-parse.js");require("./interlace.js");var t=require("./paeth-predictor.js"),i=require("../../../../../../_virtual/interlace.js").__exports,r=t.default;function s(e,t,i){var r=e*t;return 8!==i&&(r=Math.ceil(r/(8/i))),r}var a=e.filterParse.exports=function(e,t){var r=e.width,a=e.height,n=e.interlace,h=e.bpp,o=e.depth;if(this.read=t.read,this.write=t.write,this.complete=t.complete,this._imageIndex=0,this._images=[],n)for(var l=i.getImagePasses(r,a),p=0;p<l.length;p++)this._images.push({byteWidth:s(l[p].width,h,o),height:l[p].height,lineIndex:0});else this._images.push({byteWidth:s(r,h,o),height:a,lineIndex:0});this._xComparison=8===o?h:16===o?2*h:1};a.prototype.start=function(){this.read(this._images[this._imageIndex].byteWidth+1,this._reverseFilterLine.bind(this))},a.prototype._unFilterType1=function(e,t,i){for(var r=this._xComparison,s=r-1,a=0;a<i;a++){var n=e[1+a],h=a>s?t[a-r]:0;t[a]=n+h}},a.prototype._unFilterType2=function(e,t,i){for(var r=this._lastLine,s=0;s<i;s++){var a=e[1+s],n=r?r[s]:0;t[s]=a+n}},a.prototype._unFilterType3=function(e,t,i){for(var r=this._xComparison,s=r-1,a=this._lastLine,n=0;n<i;n++){var h=e[1+n],o=a?a[n]:0,l=n>s?t[n-r]:0,p=Math.floor((l+o)/2);t[n]=h+p}},a.prototype._unFilterType4=function(e,t,i){for(var s=this._xComparison,a=s-1,n=this._lastLine,h=0;h<i;h++){var o=e[1+h],l=n?n[h]:0,p=h>a?t[h-s]:0,_=h>a&&n?n[h-s]:0,u=r(p,l,_);t[h]=o+u}},a.prototype._reverseFilterLine=function(e){var t,i=e[0],r=this._images[this._imageIndex],s=r.byteWidth;if(0===i)t=e.slice(1,s+1);else switch(t=new Buffer(s),i){case 1:this._unFilterType1(e,t,s);break;case 2:this._unFilterType2(e,t,s);break;case 3:this._unFilterType3(e,t,s);break;case 4:this._unFilterType4(e,t,s);break;default:throw new Error("Unrecognised filter type - "+i)}this.write(t),r.lineIndex++,r.lineIndex>=r.height?(this._lastLine=null,this._imageIndex++,r=this._images[this._imageIndex]):this._lastLine=t,r?this.read(r.byteWidth+1,this._reverseFilterLine.bind(this)):(this._lastLine=null,this.complete())},exports.default=e.filterParse.exports;
