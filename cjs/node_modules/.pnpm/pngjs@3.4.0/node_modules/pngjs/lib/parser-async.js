"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../../../../../../_virtual/parser-async.js"),i=require("util"),e=require("zlib");require("./chunkstream.js"),require("./filter-parse-async.js"),require("./parser.js"),require("./bitmapper.js");var r=require("./format-normaliser.js"),s=require("../../../../../../_virtual/filter-parse-async.js"),a=require("../../../../../../_virtual/bitmapper.js"),n=require("../../../../../../_virtual/parser.js"),h=require("../../../../../../_virtual/chunkstream.js");function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var l=o(i),p=o(e),f=l.default,_=p.default,d=h.chunkstream.exports,u=s.filterParseAsync.exports,c=n.parser.exports,m=a.__exports,b=r.default,y=t.parserAsync.exports=function(t){d.call(this),this._parser=new c(t,{read:this.read.bind(this),error:this._handleError.bind(this),metadata:this._handleMetaData.bind(this),gamma:this.emit.bind(this,"gamma"),palette:this._handlePalette.bind(this),transColor:this._handleTransColor.bind(this),finished:this._finished.bind(this),inflateData:this._inflateData.bind(this),simpleTransparency:this._simpleTransparency.bind(this),headersFinished:this._headersFinished.bind(this)}),this._options=t,this.writable=!0,this._parser.start()};f.inherits(y,d),y.prototype._handleError=function(t){this.emit("error",t),this.writable=!1,this.destroy(),this._inflate&&this._inflate.destroy&&this._inflate.destroy(),this._filter&&(this._filter.destroy(),this._filter.on("error",(function(){}))),this.errord=!0},y.prototype._inflateData=function(t){if(!this._inflate)if(this._bitmapInfo.interlace)this._inflate=_.createInflate(),this._inflate.on("error",this.emit.bind(this,"error")),this._filter.on("complete",this._complete.bind(this)),this._inflate.pipe(this._filter);else{var i=(1+(this._bitmapInfo.width*this._bitmapInfo.bpp*this._bitmapInfo.depth+7>>3))*this._bitmapInfo.height,e=Math.max(i,_.Z_MIN_CHUNK);this._inflate=_.createInflate({chunkSize:e});var r=i,s=this.emit.bind(this,"error");this._inflate.on("error",(function(t){r&&s(t)})),this._filter.on("complete",this._complete.bind(this));var a=this._filter.write.bind(this._filter);this._inflate.on("data",(function(t){r&&(t.length>r&&(t=t.slice(0,r)),r-=t.length,a(t))})),this._inflate.on("end",this._filter.end.bind(this._filter))}this._inflate.write(t)},y.prototype._handleMetaData=function(t){this._metaData=t,this._bitmapInfo=Object.create(t),this._filter=new u(this._bitmapInfo)},y.prototype._handleTransColor=function(t){this._bitmapInfo.transColor=t},y.prototype._handlePalette=function(t){this._bitmapInfo.palette=t},y.prototype._simpleTransparency=function(){this._metaData.alpha=!0},y.prototype._headersFinished=function(){this.emit("metadata",this._metaData)},y.prototype._finished=function(){this.errord||(this._inflate?this._inflate.end():this.emit("error","No Inflate block"),this.destroySoon())},y.prototype._complete=function(t){if(!this.errord){try{var i=m.dataToBitMap(t,this._bitmapInfo),e=b(i,this._bitmapInfo);i=null}catch(t){return void this._handleError(t)}this.emit("parsed",e)}},exports.default=t.parserAsync.exports;
