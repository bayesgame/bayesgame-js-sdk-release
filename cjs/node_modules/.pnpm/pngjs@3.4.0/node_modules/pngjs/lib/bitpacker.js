"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./constants.js").default;exports.default=function(r,t,a,n){var o,i=-1!==[e.COLORTYPE_COLOR_ALPHA,e.COLORTYPE_ALPHA].indexOf(n.colorType);if(n.colorType===n.inputColorType){var O=(o=new ArrayBuffer(2),new DataView(o).setInt16(0,256,!0),256!==new Int16Array(o)[0]);if(8===n.bitDepth||16===n.bitDepth&&O)return r}var p=16!==n.bitDepth?r:new Uint16Array(r.buffer),u=255,l=e.COLORTYPE_TO_BPP_MAP[n.inputColorType];4!==l||n.inputHasAlpha||(l=3);var h=e.COLORTYPE_TO_BPP_MAP[n.colorType];16===n.bitDepth&&(u=65535,h*=2);var s=new Buffer(t*a*h),L=0,P=0,C=n.bgColor||{};function T(){var r,t,a,o=u;switch(n.inputColorType){case e.COLORTYPE_COLOR_ALPHA:o=p[L+3],r=p[L],t=p[L+1],a=p[L+2];break;case e.COLORTYPE_COLOR:r=p[L],t=p[L+1],a=p[L+2];break;case e.COLORTYPE_ALPHA:o=p[L+1],t=r=p[L],a=r;break;case e.COLORTYPE_GRAYSCALE:t=r=p[L],a=r;break;default:throw new Error("input color type:"+n.inputColorType+" is not supported at present")}return n.inputHasAlpha&&(i||(o/=u,r=Math.min(Math.max(Math.round((1-o)*C.red+o*r),0),u),t=Math.min(Math.max(Math.round((1-o)*C.green+o*t),0),u),a=Math.min(Math.max(Math.round((1-o)*C.blue+o*a),0),u))),{red:r,green:t,blue:a,alpha:o}}void 0===C.red&&(C.red=u),void 0===C.green&&(C.green=u),void 0===C.blue&&(C.blue=u);for(var c=0;c<a;c++)for(var A=0;A<t;A++){var b=T();switch(n.colorType){case e.COLORTYPE_COLOR_ALPHA:case e.COLORTYPE_COLOR:8===n.bitDepth?(s[P]=b.red,s[P+1]=b.green,s[P+2]=b.blue,i&&(s[P+3]=b.alpha)):(s.writeUInt16BE(b.red,P),s.writeUInt16BE(b.green,P+2),s.writeUInt16BE(b.blue,P+4),i&&s.writeUInt16BE(b.alpha,P+6));break;case e.COLORTYPE_ALPHA:case e.COLORTYPE_GRAYSCALE:var d=(b.red+b.green+b.blue)/3;8===n.bitDepth?(s[P]=d,i&&(s[P+1]=b.alpha)):(s.writeUInt16BE(d,P),i&&s.writeUInt16BE(b.alpha,P+2));break;default:throw new Error("unrecognised color Type "+n.colorType)}L+=l,P+=h}return s};
